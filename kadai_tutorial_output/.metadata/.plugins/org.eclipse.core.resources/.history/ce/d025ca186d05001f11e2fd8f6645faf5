package com.example.samuraitravel.service;

import org.springframework.stereotype.Service;

import com.example.samuraitravel.form.ReservationRegisterForm;
import com.stripe.exception.StripeException;
import com.stripe.model.checkout.Session;
import com.stripe.param.billingportal.SessionCreateParams;
import com.stripe.Stripe;

import jakarta.servlet.http.HttpServletRequest;

@Service
public class StripeService {
	// セッションを作成し、Stripeに必要な情報を返す
	public String createStripeSession(String houseName, ReservationRegisterForm reservationRegisterForm, HttpServletRequest httpServletRequest) {
		Stripe.apiKey = "sk_test_51PAWPfRqURbbYMYaggEPc6ntat5NxfYqZEa0NSvR51bxjjn2DrJxxZo00Ss3pBbzesciKRzk9UNJMz71cbqy6G3s0015wzseB6";
		String requestUrl = new String(httpServletRequest.getRequestURL());
		SessionCreateParams params = 
				SessionCreateParams.builder()
					.addPaymentMethodType(SessionCreateParams.PaymentMethodType.CARD)
					.addLineItem(
							SessionCreateParams.LineItem.PriceData.builder()
							.setPriceData(
									SessionCreateParams.LineItem.PriceData.builder()	
										.setProductData(
												SessionCreateParams.LineItem.PriceData.builder()
													.setName(houseName)
													.build())
										.setUnitAmount((long)reservationRegisterForm.getAmount())
										.setCurrency("jpy")
										.build()
							.setQuantity(1L)
							.build())
					.setMode(SesseionCreateParams.Mode.PAYMENT)
					.setSuccessUrl(requestUrl.replaceAll("/houses/[0-9]+/reservations/confirm", "") + "/reservations?reserved")
					.setCancelUrl(requestUrl.replace("/reservations/confirm", ""))
					.setPaymentIntentData(
							SessionCreateParams.PaymentIntentData.builder()
								.putMetadata("houseId", reservationRegisterForm.getHouseId().toString())
								.putMetadata("userId", reservationRegisterForm.getUserId().toString())
								.putMetadata("checkinData", reservationRegisterForm.getCheckinDate())
								.putMetadata("checkoutData", reservationRegisterForm.getCheckoutDate())
								.putMetadata("numberOfPeople", reservationRegisterForm.getNumberOfPeople().toString())
								.putMetadata("amount", reservationRegisterForm.getAmount().toString())
								.build())
					.build();
				try {
					Session session = Session.create(params);
					return session.getId();
				} catch (StripeException e) {
					e.printStackTrace();
					return "";
				}
	}
}

	}

}
